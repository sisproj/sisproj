<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="config.mybatis.mapper.oracle.confirm">
	<parameterMap type="map" id="insertFormParam">
		<parameter property="formName" javaType="string" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="typeType" javaType="string" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="formSecu" javaType="string" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="formLife" javaType="string" jdbcType="VARCHAR" mode="IN"/>
		<parameter property="formEx" javaType="string" jdbcType="VARCHAR" mode="IN"/>
	</parameterMap>
	
	<insert id="insertDocForm" parameterMap="insertFormParam">
		call INS_DOC_FORM(?,?,?,?,?)
	</insert>
	
	<select id="selectDocFormByFormNo" parameterType="int" resultType="DocumentFormVO" >
		select t.*, f.form_no, f.form_name, f.form_secu, f.form_life, f.form_ex
		from doc_type t
		join doc_form f
		on t.type_no = f.form_type_no
		where f.form_no=#{formNo}
	</select>
	
	<update id="updateDocForm" parameterType="DocumentFormVO">
		update doc_form 
		set form_name = #{formName}, form_secu=#{formSecu}, form_life=#{formLife}, form_ex=#{formEx} 
		where form_no = #{formNo}
	</update>
	
	<parameterMap type="map" id="deleteFormParam">
		<parameter property="formNo" javaType="int" jdbcType="INTEGER" mode="IN"/>
		<parameter property="typeNo" javaType="int" jdbcType="INTEGER" mode="IN"/>		
	</parameterMap>
	
	<delete id="deleteDocForm" parameterMap="deleteFormParam">
		call DEL_FORM_PROC(?,?)
	</delete>
	
	<select id="selectDocFormAll" resultType="DocumentFormVO">
		select t.*, f.form_no, f.form_name, f.form_secu, f.form_life, f.form_ex
		from doc_type t
		join doc_form f
		on t.type_no = f.form_type_no
	</select>
	
	<select id="selectDocTypeAll" resultType="DocumentFormVO">
		select * from doc_type
	</select>
	
	<select id="selectFormByFormNo" parameterType="int" resultType="DocumentFormVO">
		select * from doc_form where form_no = #{formNo}
	</select>
	
	<select id="selectConfirmSEQ" resultType="int">
		select confirm_seq.nextval from dual
	</select>
	
	<select id="selectSaveLineByEmpNo" parameterType="int" resultType="SaveLineVO">
		select * from save_line where emp_no = #{empNo}
	</select>
	
	<select id="selectSaveLineBySaveNo" parameterType="int" resultType="SaveLineVO">
		select * from save_line where save_no = #{saveNo}
	</select>
	
	<select id="selectConfirmerByEmpNo" parameterType="int" resultType="ConfirmLineVO">
		select e.emp_no, e.emp_name, e.pos_name, d.dept_name
		from empView e
		join dept d
		on e.dept_no = d.dept_no
		where emp_no = #{empNo}
	</select>
	
	<insert id="insertConfirmDoc" parameterType="DocumentVO">
		insert into confirm(cf_no, form_no, emp_no, link_cf_no, cf_title, cf_content, cf_isfile, cf_Status)
		values(#{cfNo}, #{formNo}, #{empNo}, #{linkCfNo}, #{cfTitle}, #{cfContent}, #{cfIsfile}, #{cfStatus})
	</insert>
	
	<insert id="insertConfirmFile" parameterType="ConfirmFileVO">
		<selectKey keyProperty="fileNo" resultType="int" order="BEFORE">
			select confirm_file_seq.nextval from dual
		</selectKey>
		insert into confirm_file(file_no, file_name, file_ori_name, file_size, cf_no)
		values(#{fileNo}, #{fileName}, #{fileOriName}, #{fileSize}, #{cfNo})
	</insert>
	
	<insert id="insertConfirmLine" parameterType="ConfirmLineVO">
		<selectKey keyProperty="lineNo" resultType="int" order="BEFORE">
			select confirm_line_seq.nextval from dual
		</selectKey>
		insert into confirm_line(line_no, emp_no, line_stat, cf_no)
		values(#{lineNo}, #{empNo}, #{lineStat}, #{cfNo})
	</insert>
	
	<select id="selectAllDoc" parameterType="ConfirmSearchVO" resultType="DocumentVO">
		select * from (
		    select rownum as RNUM, blist.* from
		    (
		        select * from confirm 
		        where cf_status = #{listType}
		        and (cf_no like '%' || #{searchKeyword} || '%' or cf_title like '%' || #{searchKeyword} || '%' or cf_content like '%' || #{searchKeyword} || '%')
		        order by cf_no desc
		    ) blist
		)
	    <![CDATA[
		where RNUM>#{firstRecordIndex} and RNUM<=#{firstRecordIndex}+#{recordCountPerPage} ]]>
	</select>
	
	<select id="totalRecordCountDoc" resultType="int" parameterType="ConfirmSearchVO">
		select count(*) from confirm where cf_status=#{listType} and (cf_no like '%' || #{searchKeyword} || '%' or cf_title like '%' || #{searchKeyword} || '%' or cf_content like '%' || #{searchKeyword} || '%')
	</select>
	
	<select id="completeDocSelByEmpNo" parameterType="int" resultType="DocumentVO">
		select * from confirm where emp_no=#{empNo} and cf_status='결재완료' order by cf_no desc
	</select>
	
	<update id="myConfirmOk" parameterType="ConfirmLineVO">
		update confirm_line set line_stat=#{lineStat} where cf_no=#{cfNo} and emp_no = #{empNo}
	</update>
</mapper>


